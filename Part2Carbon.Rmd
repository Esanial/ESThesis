---
title: "Partie 2 Services: Carbone, Diversité"
author: "Elsa SANIAL"
date: "11 juin 2018"
output: 
  html_document:
    toc: yes
    toc_float: yes
    keep_md: true

---
```{r packages, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(tidyr)
library(entropart)
library(vegan)
library(reshape)
library(ggplot2)
library(BIOMASS)
```
```{r include=FALSE}
#Full data 
tree<-read.csv2("C:/Users/Elsa/Documents/Recherche/These/Datanalysis/ESThesis/tree.csv",na.string="")
plot<-read.csv2("C:/Users/Elsa/Documents/Recherche/These/Datanalysis/ESThesis/plot.csv")
esp<-read.csv2("C:/Users/Elsa/Documents/Recherche/These/Datanalysis/ESThesis/esp.csv")
plot_na<-read.csv2("C:/Users/Elsa/Documents/Recherche/These/Datanalysis/ESThesis/plot2.csv")
```
#Estimation de la biomasse aérienne des arbres associés aux cacaoyers
```{r Sélection des parcelles pour le calcul du carbone, include=FALSE}
carbondata<-tree[!is.na(tree$peri_tig),]
```

```{r Corriger la taxonomie, include=FALSE}
Taxo<-correctTaxo(genus=carbondata$Genre,species=carbondata$Espece)
table(carbondata$Genre==Taxo$genusCorr)
carbondata$genusCorr<-Taxo$genusCorrected
table(carbondata$Espece==Taxo$speciesCorr)
carbondata$speciesCorr<-Taxo$speciesCorrected
#correction de la famille#
APG<-getTaxonomy(Taxo$genusCorrected,findOrder=T)
carbondata$familyAPG<-APG$family
carbondata$orderAPG<-APG$order
```

```{r obtenir la densité du bois par espèce, include=FALSE}
dataWD<-getWoodDensity(genus=carbondata$genusCorr,
                       species=carbondata$speciesCorr,
                       stand=carbondata$code)
table(factor(dataWD$levelWD))
carbondata$WD=dataWD$meanWD
carbondata$WDsd=dataWD$sdWD
```

```{r calcul biomasse aérienne, include=FALSE}
#transformation du périmètre en diamètre#
carbondata$diam<-2*(((carbondata$peri_tig)/2)/pi)
carbondata$taille<-as.numeric(carbondata$taille)
#Estimation de biomasse#
AGBtree<-computeAGB(D=carbondata$diam,WD=carbondata$WD,H=carbondata$taille)
carbondata$AGB=AGBtree
```

```{r somme par parcelle, include=FALSE}
Carbonestimated<-as.data.frame(tapply(carbondata$AGB,carbondata$code,sum))
#renommer la colonne#
name<-"ABGplot"
colnames(Carbonestimated)<-name
Carbonestimated<-as.data.frame(Carbonestimated[!is.na(Carbonestimated$ABGplot),])
colnames(Carbonestimated)<-name
rm("name")
```

```{r ajout au df plot, include=FALSE}
Carbonestimated$code<-rownames(Carbonestimated)
plot<-merge(plot,Carbonestimated,"code",all=TRUE)
plot$biomhect<-(plot$ABGplot/plot$sup)
```

```{r echo=FALSE}
names<-plot$code
plot(plot$densit,plot$biomhect)+
text(plot$densit,plot$biomhect,names,col=(plot$age_champ))
rm("names")
```
```{r echo=FALSE}
plot2<-plot[!is.na(plot$biomhect),]
plot2[,c("code","densit","biomhect")]
```

```{r include=FALSE}
rm("plot2")
```
#Estimation de la biomasse aérienne des cacaoyers
##Estimation de la densité des cacaoyers (nbr cacaoyers/hect)
La densité de cacaoyers n'a pas été mesurée sur les parcelles inventoriées. 

Toutefois, je dispose d'un jeu de données constitué lors de mon Master 2 (avec IDH/CIRAD/ALP). J'avais mesuré les densités de cacaoyers sur 61 parcelles de 12 à 52 ans dans l'ouest ivoirien. Sur chaque parcelle, les cacaoyers ont été comptés dans 4 carrés de 100m² (Sanial, 2015, Ruf et al., 2015). J'ai ensuite calculé la densité moyenne de ces 4 carrés pour chaque parcelle. 
Dans ce jeu de données, la relation entre âge du champ et densité peut s'écrire selon l'équation linéaire suivante : -0.15x+19.5

Ainsi, j'ai pu estimer la densité des cacaoyers en fonction de l'âge pour chacune des parcelles inventoriées dans le cadre de me thèse. 

```{r Densite moy sur les parcelles, echo=TRUE, message=FALSE, warning=FALSE}
#Ajout du cacao#
Carbonestimated<-merge(Carbonestimated,plot,"code")
Carbonestimated$kkodensit<-(((-0.15*Carbonestimated$age_champ)+19.5)*100)
```

L'estimation de la densité moyenne des cacaoyers (nbr cacaoyers/hectares) (
```{r echo=FALSE, results='asis'}
mean(Carbonestimated$kkodensit)
```
) est supérieure à ce qui a été mesuré par Stemler (2012): 1100 cacaoyers/hectares dans le sud Ivoirien. 

Toutefois, lors des inventaires botaniques, les portions de la parcelle n'ayant pas de cacaoyers ont été cartographiées au GPS. Cela permet de connaître le pourcentage d'espaces vides de cacaoyers par rapport à la superficie totale inventoriée. Une fois ce pourcentage pris en compte on obtient une densité de cacaoyers à l'hectare plus faible avec une moyenne de:

```{r include=FALSE}
Carbonestimated$kkodensitmoinsparc<-Carbonestimated$kkodensit-(Carbonestimated$kkodensit*Carbonestimated$parc/100)
```
```{r echo=FALSE,results='asis'}
mean(Carbonestimated$kkodensitmoinsparc)
```
 cacaoyers par hectare .

##Estimation de la biomasse aérienne des cacaoyers (tonnes/hectare)

La biomasse aérienne du cacaoyer, d'après le modèle de Zuidema et al.,(2005), représente 88.2% de la biomasse totale (d'après la compilation de différentes mesures effectuées au Brésil, Congo, Costa Rica, Malaysie, Nigeria et Vénézuela). 
La régression logarithmique entre l'âge de l'arbre et la biomasse est, toujours d'après ce modèle physiologique : 
9.35ln(x)+7.88. 

J'utilise cette équation pour estimer la biomasse des cacaoyers en prenant en compte l'âge de la plantation (compris ici, de manière schématique comme l'âge du cacaoyer). 

On obtient ainsi la biomasse totale. Pour obtenir une estimation de la biomasse aérienne pour chaque cacaoyer, il faut prendre 88.2% de la biomasse totale.

```{r calcul de la biomasse modele de Zuidema, echo=TRUE}
Carbonestimated$kkobiomasse<-((((9.35*log(Carbonestimated$age_champ)+7.87)*88.2)/100)*Carbonestimated$kkodensitmoinsparc)/1000
#Limite de ce calcul: les données sont prises sur des plantations ombragées, donc avec plus de biomasse cacaoyère. 
```

Une autre méthode pourrait être choisie: utiliser le package BIOMASS et prendre en compte également la hauteur des caacoyers qui est fonction de l'ombrage (20 à 25m sous ombrage fort contre 3 à 10m sous ombrage léger Van Vliet (2015)). 


#Estimation de la biomasse totale et du carbone (Tonnes/hect) (arbres associés + cacaoyers)
```{r include=FALSE}
Carbonestimated$biomtot<-Carbonestimated$biomhect+Carbonestimated$kkobiomasse
Carbonestimated$carbontot<-Carbonestimated$biomtot/2
```

```{r echo=FALSE}
Carbonestimated[,c("code","densit","biomhect","kkobiomasse","biomtot","carbontot")]
```
```{r}
hist(Carbonestimated$carbontot)
boxplot(Carbonestimated$carbontot,main="Tonne de carbone/hect")
```

Les parcelles étudiées stockent de
```{r echo=FALSE, results='asis'}
min(Carbonestimated$carbontot)
```
à
```{r echo=FALSE, results='asis'}
max(Carbonestimated$carbontot)
```
tonnes de carbone par hectare (cacaoyers+arbres associés). 

En moyenne on estime 
```{r echo=FALSE, results="asis"}
mean(Carbonestimated$carbontot)
```
(sd
```{r echo=FALSE, results="asis"}
sd(Carbonestimated$carbontot)
```
) tonnes de carbone/hectare. 

Pour indication, d'après Nijmeijer et al., (2017) une agroforêt à cacao camerounaise stocke en moyenne 72 tonnes par hectare (sd 8). 

Il convient de garder à l'esprit que l'estimation de biomasse aérienne des cacaoyers peut être sur-estimée dans notre étude: en effet les données d'observation sont issues de plantation ombragées. Dans ces conditions d'ombrage, les cacaoyers ont plus de biomasse que dans des conditions moins ombragées comme on l'observe plus couramment en Côte d'Ivoire. 

#Estimation du carbone par type d'arbres(planté, recrû,...)

```{r include=FALSE}
carbondata$meth_introsimp[carbondata$meth_intro == "1"] <- "1"
carbondata$meth_introsimp[carbondata$meth_intro == "2"] <- "2"
carbondata$meth_introsimp[carbondata$meth_intro == "3"] <- "3"
carbondata$meth_introsimp[carbondata$meth_intro == "4"] <- "1"
carbondata$meth_introsimp[carbondata$meth_intro == "5"] <- "5"
carbondata$meth_introsimp[carbondata$meth_intro == "6"] <- "1"
carbondata$meth_introsimp[carbondata$meth_intro == "7"] <- "5"
carbondata$meth_introsimp=factor(carbondata$meth_introsimp,c("1","3","5","2"))
typsimp<-tapply(carbondata$AGB,carbondata$meth_introsimp,sum)
```
```{r echo=FALSE}
barplot(typsimp,names.arg=c("Planté","Recrû \n spontané","Maintenu \n au défrichement","Don \n certification"),space=0.5,main="Carbone total estimé \n par type de mode d'introduction de l'arbre",ylab="Carbone estimé (tonnes par hectare)",xlab="Mode d'introduction",border=NA,col=grey.colors(4))

#Affiché en % du carbone total
barplot(prop.table(typsimp)*100,names.arg=c("Planté","Recrû \n spontané","Maintenu \n au défrichement","Don \n certification"),space=0.5,main="Carbone total estimé \n par type de mode d'introduction de l'arbre",ylab="Carbone estimé (% carbone total)",xlab="Mode d'introduction",border=NA,col=grey.colors(4))
rm("typsimp")
```

```{r include=FALSE}
#Calcul du carbone seulement pour les arbres plantés
carbondata$carbon<-carbondata$AGB/2
carbonpl<-subset(carbondata, meth_introsimp %in% c("1","2"))
plotcarbpl<-as.data.frame(tapply(carbonpl$carbon,carbonpl$code,sum))
#Il manque une parcelle
```

```{r include=FALSE}
#Calcul du carbone seulement pour les arbres de recrû et de maintien au défrichement
carbonrec<-subset(carbondata, meth_introsimp %in% c("5","3"))
plotcarbrec<-as.data.frame(tapply(carbonrec$carbon,carbonrec$code,sum))
#Calcul du carbone seulement pour les arbres de recrû spontané
carbonrecsp<-subset(carbondata, meth_introsimp %in% c("3"))
plotcarbrecsp<-as.data.frame(tapply(carbonrecsp$carbon,carbonrecsp$code,sum))
```
```{r include=FALSE}
plotcarbpl$carbpl<-plotcarbpl[,1]
plotcarbrec$carbrec<-plotcarbrec[,1]
plotcarbrecsp$carbrecsp<-plotcarbrecsp[,1]
```
```{r include=FALSE}
plotcarbpl$code<-rownames(plotcarbpl)
plotcarbrec$code<-rownames(plotcarbrec)
plotcarbrecsp$code<-rownames(plotcarbrecsp)
Carbonestimated<-merge(Carbonestimated,plotcarbrec,"code",all=TRUE)
Carbonestimated<-merge(Carbonestimated,plotcarbpl,"code",all=TRUE)
Carbonestimated<-merge(Carbonestimated,plotcarbrecsp,"code",all=TRUE)
Carbonestimated$`tapply(carbonrec$carbon, carbonrec$code, sum)`=NULL
Carbonestimated$`tapply(carbonpl$carbon, carbonpl$code, sum)` =NULL
Carbonestimated$`tapply(carbonrecsp$carbon, carbonrecsp$code, sum)`=NULL
rm("carbonpl","carbonrec","plotcarbpl","plotcarbrec","plotcarbrecsp","carbonrecsp","APG","dataWD","Taxo","AGBtree")
```


#Covariance Carbone et déterminants environnementaux
##Age

```{r Covariance carbone age, include=FALSE}
plot(Carbonestimated$age_champ,Carbonestimated$carbontot, main="Carbone total (tonne/hectare) par parcelle \n en fonction de l'âge du champ",xlab="Age du champ", ylab="Carbone (tonne/hectare)")
```
```{r include=FALSE}
Carbonestimated$carbpl<-as.numeric(Carbonestimated$carbpl)
Carbonestimated$carbpl<-Carbonestimated$carbpl/Carbonestimated$sup
Carbonestimated$carbrec<-as.numeric(Carbonestimated$carbrec)
Carbonestimated$carbrec<-Carbonestimated$carbrec/Carbonestimated$sup
Carbonestimated$carbrecsp<-as.numeric(Carbonestimated$carbrecsp)
Carbonestimated$carbrecsp<-Carbonestimated$carbrecsp/Carbonestimated$sup

Carbonestimated<-Carbonestimated[!is.na(Carbonestimated$site),]
Carbonestimated[is.na(Carbonestimated$carbpl),"carbpl"]<-0
Carbonestimated[is.na(Carbonestimated$carbrec),"carbrec"]<-0
Carbonestimated[is.na(Carbonestimated$carbrecsp),"carbrecsp"]<-0
```

```{r echo=FALSE}
plot(Carbonestimated$age_champ,Carbonestimated$carbpl,main="Carbone stocké par les arbres plantés en fonction de l'âge du champ",xlab="Age du champ", ylab="Carbone (tonne/hectare)")
```

```{r echo=FALSE}
plot(Carbonestimated$age_champ,Carbonestimated$carbrec, main="Carbone stocké par les arbres de recrû \n ou maintenus au défrichement en fonction de l'âge du champ",xlab="Age du champ", ylab="Carbone (tonne/hectare)")
```
```{r echo=FALSE}
plot(Carbonestimated$age_champ,Carbonestimated$carbrecsp, main="Carbone stocké par les arbres de recrû spontanés \n en fonction de l'âge du champ", xlab="Age du champ", ylab="Carbone (tonne/hectare)")
```

##Occupation des sols
###Bas fonds
```{r echo=FALSE}
plot(Carbonestimated$bf,Carbonestimated$carbrecsp, main="Proximité d'un bas fond et carbone recrû spontané", xlab="% occupé par un bas fond dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

```{r echo=FALSE}
plot(Carbonestimated$bf,Carbonestimated$carbrec, main="Proximité d'un bas fond et carbone recrû spontané et maintien au défrichement", xlab="% occupé par un bas fond dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```


```{r echo=FALSE}
plot(Carbonestimated$bf,Carbonestimated$carbontot, main="Proximité d'un bas fond et carbone total", xlab="% occupé par un bas fond dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

###Cacao
La proximité d'une cacaoyère agroforestière pourrait permettre la diffusion de certaines espèces arborées repoussant spontanément dans les cacaoyères. Ainsi, les parcelles qui se situent au milieu d'un grand bloc de cacaoyères (comme on l'observe souvent) pourraient connaître un recrû spontané plus important et plus variés que celles situées à procximité de bas fonds ou de cultures permanentes. 

```{r echo=FALSE}
plot(Carbonestimated$kko,Carbonestimated$carbrecsp, main="Proximité de cacaoyère et carbone recrû spontané", xlab="% occupé par des cacaoyères dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

```{r echo=FALSE}
plot(Carbonestimated$kko,Carbonestimated$carbrec, main="Proximité des cacaoyères et carbone \n recrû spontané et maintien au défrichement", xlab="% occupé par des cacaoyères dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```


```{r echo=FALSE}
plot(Carbonestimated$kko,Carbonestimated$carbontot, main="Proximité de cacaoyères et carbone total", xlab="% occupé par des cacaoyères dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

###Forêt
```{r echo=FALSE}
plot(Carbonestimated$for.,Carbonestimated$carbrecsp, main="Proximité de forêts et carbone recrû spontané", xlab="% occupé par des forêts dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

```{r echo=FALSE}
plot(Carbonestimated$for.,Carbonestimated$carbrec, main="Proximité de forêts et carbone \n recrû spontané et maintien au défrichement", xlab="% occupé par des forêts dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

```{r echo=FALSE}
plot(Carbonestimated$for.,Carbonestimated$carbontot, main="Proximité de forêts et carbone total", xlab="% occupé par des forêts dans un rayon de 300m", ylab="Carbone (tonne/hectare)")
```

#Service diversité
```{r abundance vector, include=FALSE}
abdvec<-table(tree$nom_sc,tree$code)
```

```{r metacommunity creation, message=FALSE, warning=FALSE, include=FALSE}
Metacom<-MetaCommunity(abdvec)
```

##Diversité Alpha, Bêta et Gamma pour q=0
```{r alpha bêta and gamme div q0, echo=FALSE}
#q0<-DivEst(0,Metacom)
#save(q0,file="q0")
load("q0")
summary(q0)
plot(q0)

```

```{r include=FALSE}
q0div<-as.data.frame(q0$CommunityAlphaDiversities)
#Il manque une parcelle, vérifier (136 au lieu de 137 dans plot)
```

##Diversité Alpha, Bêta et Gamma pour q=2

```{r alpha bêta and gamme div q2, echo=FALSE}
#q2<-DivEst(2,Metacom)
#save(q2,file="q2")
load("q2")
summary(q2)
plot(q2)

```

```{r include=FALSE}
q2div<-as.data.frame(q2$CommunityAlphaDiversities)
#Il manque une parcelle, vérifier (136 au lieu de 137 dans plot)
```


##Diversité Alpha, Bêta et Gamma pour les arbres spontanés

```{r echo=FALSE}
#treesp<-subset(tree, meth_intro %in% c("3"))
#abdvecsp<-table(treesp$nom_sc,treesp$code)
#Metacomsp<-MetaCommunity(abdvecsp)
#q0sp<-DivEst(0,Metacomsp)
#save(q0sp,file="q0sp")
load("q0sp")
plot(q0sp)
```

```{r include=FALSE}
q0spdiv<-as.data.frame(q0sp$CommunityAlphaDiversities)
```

```{r include=FALSE}
plot<-merge(Carbonestimated[,c("carbontot","carbrec","carbpl","carbrecsp","code")],plot,"code",all=TRUE)
q0div$code<-rownames(q0div)
q2div$code<-rownames(q2div)
q0spdiv$code<-rownames(q0spdiv)
q0div$q0al<-q0div$`q0$CommunityAlphaDiversities`
q0div$`q0$CommunityAlphaDiversities`=NULL
q2div$q2al<-q2div$`q2$CommunityAlphaDiversities`
q2div$`q2$CommunityAlphaDiversities`=NULL
q0spdiv$q0alsp<-q0spdiv$`q0sp$CommunityAlphaDiversities`
q0spdiv$`q0sp$CommunityAlphaDiversities`=NULL
plot<-merge(q0div,plot,"code")
plot<-merge(q2div,plot,"code")
plot<-merge(q0spdiv,plot,"code")
```

Observation de la covariance entre diversité et carbone: est-ce que plus la parcelle est diverse, plus elle stocke de carbone?

```{r echo=FALSE}
a<-lm(plot$q0al~plot$carbontot)
summary(a)
coeff=coefficients(a)
eq=paste0("y=",round(coeff[2],1),"x +",round(coeff[1],1))
plot(plot$carbontot,plot$q0al,abline(a,col="red"),main=eq,xlab= "carbone total (tonne/hectares)",ylab="Indice de diversité alpha d'ordre 0")
```

Observation de la covariance entre carbone stocké par le recrû spontané et diversité de ce recrû

```{r echo=FALSE}
a<-lm(plot$q0alsp~plot$carbrec)
summary(a)
coeff=coefficients(a)
eq=paste0("y=",round(coeff[2],1),"x +",round(coeff[1],1))
plot(plot$carbrec,plot$q0alsp,abline(a,col="red"),main=eq,xlab= "carbone arbres spontanés (tonne/hectares)",ylab="Indice de diversité alpha d'ordre 0 \n (arbres spontanés seulement")
```


#Covariance Diversité et déterminants environnementaux
##Densité/Diversité
```{r echo=FALSE}
plot(plot$densit,plot$q0alsp,main="Relation entre densité et diversité", xlab="Densité totale (nb/arbres par hectare)", ylab="Indice de diversité alpha q=0")
```

##Age

```{r Covariance carbone et age, echo=FALSE}
plot(plot$age_champ,plot$q0al, main="Indice de diversité par parcelle \n en fonction de l'âge du champ",xlab="Age du champ", ylab="Indice de diversité alpha d'ordre 0")
```

```{r echo=FALSE}
#c<-lm(plot$age_champ~plot$q0alsp)
#summary(c)
plot(plot$age_champ,plot$q0alsp,main="Indice de diversité (arbres spontanés) par parcelle \n en fonction de l'âge du champ",xlab="Age du champ", ylab="Indice de diversité alpha d'ordre 0")
```

##Occupation des sols: effet sur le recrû spontané
###Bas fonds
```{r echo=FALSE}
plot(plot$bf,plot$q0alsp, main="Proximité d'un bas fond et diversité du recrû spontané", xlab="% occupé par un bas fond dans un rayon de 300m", ylab="Indice de diversité alpha q=0")
```


###Cacao
```{r echo=FALSE}
d<-lm(plot$q0alsp~plot$kko)
summary(d)
plot(plot$kko,plot$q0alsp,abline(d,col="red"),main="Proximité de cacaoyères et diversité du recrû spontané", xlab="% occupé par des cacaoyères dans un rayon de 300m", ylab="Indice de diversité alpha q=0")
```

###Forêt
```{r echo=FALSE}
plot(plot$for.,plot$q0alsp,main="Proximité de forêts et diversité du recrû spontané", xlab="% occupé par des forêts dans un rayon de 300m", ylab="Indice de diversité alpha q=0")
```

###Autres cultures permanentes en monoculture (palmier, hévéa, teck etc...)
```{r echo=FALSE}
a<-lm(plot$per~plot$q0alsp)
plot(plot$per,plot$q0alsp,abline(a,col="red"),main="Proximité d'autres cultures permanentes et diversité du recrû spontané", xlab="% occupé par d'autres cultures permanentes dans un rayon de 300m", ylab="Indice de diversité alpha q=0")
```

##Relief

###Altitude
```{r echo=FALSE}
plot(plot$altmx,plot$q0alsp,main="Relation entre diversité du recrû spontané et altitude", xlab="Altitude (m)", ylab="Indice de diversité alpha q=0")
```

###Pente
```{r echo=FALSE}
plot(plot$slope,plot$q0alsp,main="Relation entre diversité du recrû spontané et pente", xlab="Pente (%)", ylab="Indice de diversité alpha q=0")
```

#Conclusion
Les éléments qui ont retenu mon attention:

- la variable "kko" (% de superficie occupée par des cacaoyères dans un rayon de 300m autour de la parcelle inventoriée) semble covarier positivement avec la variable carbone total (carbontot) et la variable diversité alpha d'ordre 0 du recrû spontané (q0alsp). 

- la variable "per" (% de superficie occupée par des cultures permanentes (monocultures) dans un rayon de 300m autour de la parcelle inventoriée) semble covarier négativement avec la variable diversité. 

- distribution d'apparence normale autour de la variable altitude

- pas d'effet apparent de la pente sur la diversité
